import { createOptimizedPicture } from '../../scripts/aem.js';
import { moveInstrumentation } from '../../scripts/scripts.js';

export default function decorate(block) {
  /* change to ul, li */
  const ul = document.createElement('ul');
  ul.setAttribute('role', 'list');
  ul.setAttribute('aria-label', 'Card list');
  const totalCards = block.children.length;
  [...block.children].forEach((row, index) => {
    const li = document.createElement('li');
    li.setAttribute('aria-label', `Card ${index + 1} of ${totalCards}`);
    moveInstrumentation(row, li);
    while (row.firstElementChild) li.append(row.firstElementChild);
    [...li.children].forEach((div) => {
      if (div.children.length === 1 && div.querySelector('picture')) div.className = 'cards-card-image';
      else div.className = 'cards-card-body';
    });
    ul.append(li);
  });
  ul.querySelectorAll('picture > img').forEach((img) => {
    const optimizedPic = createOptimizedPicture(img.src, img.alt, false, [{ width: '750' }]);
    const optimizedImg = optimizedPic.querySelector('img');
    moveInstrumentation(img, optimizedImg);
    // Ensure alt text is preserved or set to empty for decorative images
    if (!optimizedImg.getAttribute('alt') && !img.alt) {
      optimizedImg.setAttribute('alt', '');
      optimizedImg.setAttribute('aria-hidden', 'true');
    } else if (img.alt) {
      // Preserve existing alt text
      optimizedImg.setAttribute('alt', img.alt);
    }
    img.closest('picture').replaceWith(optimizedPic);
  });

  // Process each card
  ul.querySelectorAll('li').forEach((li) => {
    // Combine all cards-card-body divs into a single one
    const bodyDivs = Array.from(li.querySelectorAll('.cards-card-body'));
    if (bodyDivs.length > 1) {
      // Create a new single body div
      const singleBody = document.createElement('div');
      singleBody.className = 'cards-card-body';

      // Append all content from existing body divs
      bodyDivs.forEach((bodyDiv) => {
        while (bodyDiv.firstChild) {
          singleBody.appendChild(bodyDiv.firstChild);
        }
      });

      // Replace the first body div with the combined one
      bodyDivs[0].replaceWith(singleBody);

      // Remove the remaining body divs
      bodyDivs.slice(1).forEach((bodyDiv) => {
        if (bodyDiv.parentNode) {
          bodyDiv.remove();
        }
      });
    }

    // Handle icon: if first p is "Icon", create icon div
    const cardBody = li.querySelector('.cards-card-body');
    let iconDiv = li.querySelector('.card-icon');
    if (cardBody) {
      const firstP = cardBody.querySelector('p:first-of-type');
      if (firstP && firstP.textContent.trim().toLowerCase() === 'icon') {
        // Find picture element - check in cards-card-image first, then siblings
        let picture = null;
        const imageDiv = li.querySelector('.cards-card-image');
        if (imageDiv) {
          picture = imageDiv.querySelector('picture');
        }

        // If not found in image div, check next sibling elements
        if (!picture) {
          let nextSibling = firstP.nextElementSibling;
          while (nextSibling && !picture) {
            picture = nextSibling.querySelector('picture') || (nextSibling.tagName === 'PICTURE' ? nextSibling : null);
            if (!picture) {
              nextSibling = nextSibling.nextElementSibling;
            }
          }
        }

        // If not found, check previous sibling
        if (!picture) {
          let prevSibling = firstP.previousElementSibling;
          while (prevSibling && !picture) {
            picture = prevSibling.querySelector('picture') || (prevSibling.tagName === 'PICTURE' ? prevSibling : null);
            if (!picture) {
              prevSibling = prevSibling.previousElementSibling;
            }
          }
        }

        // If still not found, check within the paragraph
        if (!picture) {
          picture = firstP.querySelector('picture');
        }

        // Create icon div if it doesn't exist
        if (!iconDiv) {
          iconDiv = document.createElement('div');
          iconDiv.className = 'card-icon';
          iconDiv.setAttribute('aria-hidden', 'true');
        }

        if (picture) {
          // Move the picture element to icon div (don't clone, move it)
          const pictureImg = picture.querySelector('img');
          if (pictureImg && !pictureImg.getAttribute('alt')) {
            pictureImg.setAttribute('alt', '');
            pictureImg.setAttribute('aria-hidden', 'true');
          }
          iconDiv.appendChild(picture);
        }

        // Insert icon div after image div if it exists, otherwise as first element
        if (imageDiv) {
          if (!iconDiv.parentNode) {
            imageDiv.insertAdjacentElement('afterend', iconDiv);
          }
        } else if (!iconDiv.parentNode) {
          li.insertBefore(iconDiv, li.firstChild);
        }

        // Remove the image div if it's now empty
        if (imageDiv && imageDiv.children.length === 0) {
          imageDiv.remove();
        }

        // Remove the "Icon" paragraph from body
        firstP.remove();
      }
    }

    // Handle icon SVG replacement if card-icon exists
    if (iconDiv && cardBody) {
      const firstP = cardBody.querySelector('p:first-of-type');
      if (firstP) {
        const iconName = firstP.textContent.trim().toLowerCase();
        const iconMap = {
          'moving-arrow': '<svg width="20" height="12" viewBox="0 0 20 12" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1.054 11.4038L0 10.35L5.127 5.223C5.6655 4.691 6.3145 4.42342 7.074 4.42025C7.83367 4.41708 8.48275 4.68467 9.02125 5.223L10.1712 6.373C10.4226 6.62433 10.7193 6.74842 11.0615 6.74525C11.4038 6.74208 11.7007 6.618 11.952 6.373L16.8348 1.5H13.904V0H19.404V5.5H17.904V2.56925L13.0058 7.44225C12.4674 7.97425 11.8168 8.24192 11.054 8.24525C10.2912 8.24842 9.64375 7.984 9.11175 7.452L7.93675 6.277C7.69558 6.03583 7.40292 5.91692 7.05875 5.92025C6.71442 5.92342 6.42175 6.04233 6.18075 6.277L1.054 11.4038Z" fill="white"/></svg>',
          'energy-proragm-icon': '<svg width="22" height="20" viewBox="0 0 22 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1.80775 19.25C1.31058 19.25 0.885 19.073 0.531 18.719C0.177 18.365 0 17.9394 0 17.4423V4.05775C0 3.56058 0.177 3.135 0.531 2.781C0.885 2.427 1.31058 2.25 1.80775 2.25H9.75V3.75H1.80775C1.71792 3.75 1.64417 3.77883 1.5865 3.8365C1.52883 3.89417 1.5 3.96792 1.5 4.05775V17.4423C1.5 17.5321 1.52883 17.6058 1.5865 17.6635C1.64417 17.7212 1.71792 17.75 1.80775 17.75H15.1923C15.2821 17.75 15.3558 17.7212 15.4135 17.6635C15.4712 17.6058 15.5 17.5321 15.5 17.4423V11.5H17V17.4423C17 17.9394 16.823 18.365 16.469 18.719C16.115 19.073 15.6894 19.25 15.1923 19.25H1.80775ZM3.8655 15.5H5.36525V9H3.8655V15.5ZM7.75 15.5H9.25V6H7.75V15.5ZM11.6348 15.5H13.1345V12H11.6348V15.5ZM16.5 9.5C15.9872 9.5 15.4891 9.41925 15.0057 9.25775C14.5224 9.09608 14.0724 8.86275 13.6557 8.55775L13.127 9.04225C12.9718 9.18075 12.792 9.25158 12.5875 9.25475C12.383 9.25792 12.2115 9.19033 12.073 9.052C11.9282 8.907 11.8558 8.73133 11.8558 8.525C11.8558 8.31867 11.9282 8.143 12.073 7.998L12.6173 7.4635C12.3443 7.057 12.1314 6.62567 11.9788 6.1695C11.8263 5.71317 11.75 5.24 11.75 4.75C11.75 3.43583 12.2132 2.31567 13.1395 1.3895C14.0657 0.463167 15.1858 0 16.5 0H21.25V4.75C21.25 6.06417 20.7868 7.18433 19.8605 8.1105C18.9343 9.03683 17.8142 9.5 16.5 9.5ZM16.5 8C17.4028 8 18.1702 7.684 18.802 7.052C19.434 6.42017 19.75 5.65283 19.75 4.75V1.5H16.5C15.5972 1.5 14.8298 1.816 14.198 2.448C13.566 3.07983 13.25 3.84717 13.25 4.75C13.25 5.03867 13.2933 5.31633 13.3798 5.583C13.4663 5.8495 13.5737 6.11158 13.702 6.36925L16.523 3.548C16.668 3.40317 16.8437 3.33075 17.05 3.33075C17.2563 3.33075 17.4312 3.4025 17.5748 3.546C17.7313 3.7025 17.8095 3.883 17.8095 4.0875C17.8095 4.292 17.732 4.47183 17.577 4.627L14.7653 7.4385C15.0204 7.61533 15.2964 7.75317 15.5932 7.852C15.8899 7.95067 16.1922 8 16.5 8Z" fill="white"/></svg>',
          thunderstorm: '<svg width="14" height="19" viewBox="0 0 14 19" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M5.598 15.5943L10.773 9.39425H6.773L7.498 3.71925L2.873 10.3943H6.348L5.598 15.5943ZM3.625 18.8365L4.625 11.8943H0L8.24025 0H9.471L8.48075 7.89425H13.9805L4.85575 18.8365H3.625Z" fill="white"/></svg>',
          'dollar-sign': '<svg width="9" height="18" viewBox="0 0 9 18" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.64225 17.5V15.4078C2.77175 15.2526 2.02208 14.9125 1.39325 14.3875C0.764416 13.8625 0.3 13.1283 0 12.1848L1.3885 11.6077C1.65767 12.3821 2.04125 12.9744 2.53925 13.3848C3.03742 13.7949 3.7025 14 4.5345 14C5.25633 14 5.89325 13.8283 6.44525 13.4848C6.99708 13.1411 7.273 12.5962 7.273 11.85C7.273 11.2025 7.06567 10.6855 6.651 10.299C6.23617 9.9125 5.37817 9.509 4.077 9.0885C2.71417 8.65767 1.76767 8.15383 1.2375 7.577C0.707333 7 0.44225 6.27433 0.44225 5.4C0.44225 4.39367 0.7955 3.60167 1.502 3.024C2.20833 2.4465 2.92175 2.12567 3.64225 2.0615V0H5.14225V2.0615C5.90508 2.16283 6.54608 2.41092 7.06525 2.80575C7.58458 3.20058 7.98842 3.71408 8.27675 4.34625L6.90775 4.973C6.68842 4.491 6.38258 4.11667 5.99025 3.85C5.59808 3.58333 5.08208 3.45 4.44225 3.45C3.68975 3.45 3.08492 3.63333 2.62775 4C2.17075 4.36667 1.94225 4.83333 1.94225 5.4C1.94225 5.982 2.17625 6.44742 2.64425 6.79625C3.11208 7.14492 3.98192 7.51025 5.25375 7.89225C6.43575 8.25125 7.31783 8.76283 7.9 9.427C8.482 10.091 8.773 10.8884 8.773 11.8193C8.773 12.9128 8.42142 13.7614 7.71825 14.3652C7.01508 14.9692 6.15642 15.327 5.14225 15.4385V17.5H3.64225Z" fill="white"/></svg>',
          chart: '<svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1.80775 17.5C1.30258 17.5 0.875 17.325 0.525 16.975C0.175 16.625 0 16.1974 0 15.6923V0H1.5V15.6923C1.5 15.7692 1.53208 15.8398 1.59625 15.9038C1.66025 15.9679 1.73075 16 1.80775 16H17.5V17.5H1.80775ZM3.44225 14.25V6.09625H6.44225V14.25H3.44225ZM8.19225 14.25V1.09625H11.1923V14.25H8.19225ZM12.9423 14.25V10.0963H15.9423V14.25H12.9423Z" fill="white"/></svg>',
          user: '<svg width="23" height="15" viewBox="0 0 23 15" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M11.75 6.95C12.1755 6.48717 12.4902 5.95575 12.6943 5.35575C12.8981 4.75575 13 4.13717 13 3.5C13 2.86283 12.8981 2.24425 12.6943 1.64425C12.4902 1.04425 12.1755 0.512833 11.75 0.05C12.6282 0.151333 13.3573 0.5305 13.9375 1.1875C14.5175 1.84467 14.8075 2.6155 14.8075 3.5C14.8075 4.38467 14.5175 5.1555 13.9375 5.8125C13.3573 6.4695 12.6282 6.84867 11.75 6.95ZM17 14.6155V12.2692C17 11.7241 16.8891 11.2054 16.6672 10.7133C16.4454 10.2211 16.1307 9.79875 15.723 9.44625C16.4897 9.70142 17.1954 10.0457 17.8403 10.479C18.4851 10.9123 18.8075 11.5091 18.8075 12.2692V14.6155H17ZM18.8075 8.05775V6.05775H16.8075V4.55775H18.8075V2.55775H20.3075V4.55775H22.3075V6.05775H20.3075V8.05775H18.8075ZM7.5 7C6.5375 7 5.7135 6.65733 5.028 5.972C4.34267 5.2865 4 4.4625 4 3.5C4 2.5375 4.34267 1.71358 5.028 1.02825C5.7135 0.34275 6.5375 0 7.5 0C8.4625 0 9.28642 0.34275 9.97175 1.02825C10.6573 1.71358 11 2.5375 11 3.5C11 4.4625 10.6573 5.2865 9.97175 5.972C9.28642 6.65733 8.4625 7 7.5 7ZM0 14.6155V12.3923C0 11.9026 0.133 11.4491 0.399 11.0317C0.665 10.6144 1.02042 10.2936 1.46525 10.0693C2.45375 9.58475 3.45092 9.22133 4.45675 8.979C5.46242 8.73667 6.47683 8.6155 7.5 8.6155C8.523 8.6155 9.53742 8.73667 10.5433 8.979C11.5489 9.22133 12.546 9.58475 13.5345 10.0693C13.9793 10.2936 14.3348 10.6144 14.6008 11.0317C14.8669 11.4491 15 11.9026 15 12.3923V14.6155H0ZM7.5 5.5C8.05 5.5 8.52083 5.30417 8.9125 4.9125C9.30417 4.52083 9.5 4.05 9.5 3.5C9.5 2.95 9.30417 2.47917 8.9125 2.0875C8.52083 1.69583 8.05 1.5 7.5 1.5C6.95 1.5 6.47917 1.69583 6.0875 2.0875C5.69583 2.47917 5.5 2.95 5.5 3.5C5.5 4.05 5.69583 4.52083 6.0875 4.9125C6.47917 5.30417 6.95 5.5 7.5 5.5ZM1.5 13.1155H13.5V12.3923C13.5 12.1898 13.4413 12.0023 13.324 11.8298C13.2067 11.6574 13.0473 11.5168 12.846 11.4078C11.9845 10.9834 11.1061 10.6619 10.2107 10.4433C9.31525 10.2248 8.41167 10.1155 7.5 10.1155C6.58817 10.1155 5.68458 10.2248 4.78925 10.4433C3.89375 10.6619 3.01525 10.9834 2.15375 11.4078C1.95242 11.5168 1.79317 11.6574 1.676 11.8298C1.55867 12.0023 1.5 12.1898 1.5 12.3923V13.1155Z" fill="white"/></svg>',
          bag: '<svg width="19" height="18" viewBox="0 0 19 18" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 12.25C9.98583 12.25 10.399 12.0798 10.7395 11.7395C11.0798 11.399 11.25 10.9858 11.25 10.5C11.25 10.0142 11.0798 9.601 10.7395 9.2605C10.399 8.92017 9.98583 8.75 9.5 8.75C9.01417 8.75 8.601 8.92017 8.2605 9.2605C7.92017 9.601 7.75 10.0142 7.75 10.5C7.75 10.9858 7.92017 11.399 8.2605 11.7395C8.601 12.0798 9.01417 12.25 9.5 12.25ZM1.80775 17.5C1.30258 17.5 0.875 17.325 0.525 16.975C0.175 16.625 0 16.1974 0 15.6923V5.30775C0 4.80258 0.175 4.375 0.525 4.025C0.875 3.675 1.30258 3.5 1.80775 3.5H6V1.80775C6 1.30258 6.175 0.875 6.525 0.525C6.875 0.175 7.30258 0 7.80775 0H11.1923C11.6974 0 12.125 0.175 12.475 0.525C12.825 0.875 13 1.30258 13 1.80775V3.5H17.1923C17.6974 3.5 18.125 3.675 18.475 4.025C18.825 4.375 19 4.80258 19 5.30775V15.6923C19 16.1974 18.825 16.625 18.475 16.975C18.125 17.325 17.6974 17.5 17.1923 17.5H1.80775ZM1.80775 16H17.1923C17.2693 16 17.3398 15.9679 17.4038 15.9038C17.4679 15.8398 17.5 15.7692 17.5 15.6923V5.30775C17.5 5.23075 17.4679 5.16025 17.4038 5.09625C17.3398 5.03208 17.2693 5 17.1923 5H1.80775C1.73075 5 1.66025 5.03208 1.59625 5.09625C1.53208 5.16025 1.5 5.23075 1.5 5.30775V15.6923C1.5 15.7692 1.53208 15.8398 1.59625 15.9038C1.66025 15.9679 1.73075 16 1.80775 16ZM7.5 3.5H11.5V1.80775C11.5 1.73075 11.4679 1.66025 11.4038 1.59625C11.3398 1.53208 11.2692 1.5 11.1923 1.5H7.80775C7.73075 1.5 7.66025 1.53208 7.59625 1.59625C7.53208 1.66025 7.5 1.73075 7.5 1.80775V3.5Z" fill="white"/></svg>',
          handshake: '<svg width="22" height="19" viewBox="0 0 22 19" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10.2932 17.4807C10.3918 17.4807 10.4922 17.4577 10.5942 17.4115C10.696 17.3653 10.7764 17.3128 10.8354 17.2538L18.8334 9.25575C19.0591 9.03008 19.229 8.789 19.3432 8.5325C19.4572 8.27617 19.5142 8.007 19.5142 7.725C19.5142 7.43267 19.4572 7.15125 19.3432 6.88075C19.229 6.61008 19.0591 6.36708 18.8334 6.15175L14.8334 2.15175C14.6181 1.92608 14.3848 1.761 14.1334 1.6565C13.8823 1.55217 13.6105 1.5 13.3182 1.5C13.0362 1.5 12.7653 1.55217 12.5057 1.6565C12.246 1.761 12.0066 1.92608 11.7874 2.15175L11.2142 2.725L13.0642 4.59025C13.2885 4.80442 13.4543 5.04867 13.5614 5.323C13.6684 5.59733 13.7219 5.88192 13.7219 6.17675C13.7219 6.78708 13.5181 7.29608 13.1104 7.70375C12.7028 8.11142 12.1938 8.31525 11.5834 8.31525C11.2886 8.31525 11.003 8.2665 10.7267 8.169C10.4505 8.07167 10.2053 7.91592 9.99118 7.70175L8.09693 5.823L3.75093 10.169C3.67526 10.2447 3.61851 10.3293 3.58068 10.423C3.54285 10.5165 3.52393 10.6127 3.52393 10.7115C3.52393 10.896 3.58676 11.0537 3.71243 11.1845C3.8381 11.3153 3.99318 11.3808 4.17768 11.3808C4.27651 11.3808 4.37685 11.3577 4.47868 11.3115C4.58068 11.2653 4.66118 11.2128 4.72018 11.1538L8.00468 7.86925L9.05843 8.923L5.78918 12.2075C5.71368 12.2832 5.65701 12.3678 5.61918 12.4615C5.58135 12.555 5.56243 12.6512 5.56243 12.75C5.56243 12.9282 5.62685 13.0817 5.75568 13.2105C5.88451 13.3393 6.03801 13.4038 6.21618 13.4038C6.31501 13.4038 6.41535 13.3807 6.51718 13.3345C6.61918 13.2883 6.6996 13.2358 6.75843 13.1768L10.1584 9.79225L11.2124 10.846L7.82768 14.246C7.75851 14.305 7.70343 14.3854 7.66243 14.4873C7.62143 14.5892 7.60093 14.6896 7.60093 14.7883C7.60093 14.9666 7.66535 15.1202 7.79418 15.249C7.92301 15.3778 8.07651 15.4423 8.25468 15.4423C8.35335 15.4423 8.44951 15.4233 8.54318 15.3855C8.63668 15.3477 8.72126 15.2909 8.79693 15.2153L12.1969 11.8308L13.2509 12.8845L9.85093 16.2845C9.77526 16.3602 9.71851 16.448 9.68068 16.548C9.64285 16.648 9.62393 16.7442 9.62393 16.8365C9.62393 17.021 9.69251 17.1745 9.82968 17.297C9.96685 17.4195 10.1213 17.4807 10.2932 17.4807ZM10.2777 18.9805C9.71235 18.9805 9.21943 18.7844 8.79893 18.3923C8.37843 17.9999 8.1586 17.5114 8.13943 16.9268C7.57276 16.8883 7.09935 16.687 6.71918 16.323C6.33901 15.9588 6.13293 15.4806 6.10093 14.8883C5.5086 14.8499 5.02976 14.6429 4.66443 14.2673C4.29893 13.8916 4.10335 13.4191 4.07768 12.8497C3.48285 12.8114 2.99185 12.5958 2.60468 12.2028C2.21751 11.8098 2.02393 11.3127 2.02393 10.7115C2.02393 10.4167 2.08001 10.1278 2.19218 9.845C2.30435 9.56233 2.46751 9.314 2.68168 9.1L8.09693 3.7L11.0259 6.62875C11.0848 6.69792 11.1619 6.75308 11.2574 6.79425C11.3531 6.83525 11.4567 6.85575 11.5682 6.85575C11.7502 6.85575 11.9072 6.7955 12.0392 6.675C12.1713 6.5545 12.2374 6.39675 12.2374 6.20175C12.2374 6.09025 12.2169 5.98675 12.1759 5.89125C12.1348 5.79575 12.0796 5.7185 12.0104 5.6595L8.50268 2.15175C8.28735 1.92608 8.05243 1.761 7.79793 1.6565C7.54343 1.55217 7.27001 1.5 6.97768 1.5C6.69568 1.5 6.4281 1.55217 6.17493 1.6565C5.9216 1.761 5.68218 1.92608 5.45668 2.15175L2.17193 5.45175C1.98993 5.63375 1.84093 5.84883 1.72493 6.097C1.60893 6.345 1.54068 6.59792 1.52018 6.85575C1.49951 7.06858 1.5091 7.27917 1.54893 7.4875C1.5886 7.69583 1.65843 7.89167 1.75843 8.075L0.654681 9.17875C0.429014 8.85308 0.259181 8.48833 0.145181 8.0845C0.0310144 7.68067 -0.015819 7.27108 0.004681 6.85575C0.025181 6.39542 0.129014 5.95083 0.316181 5.522C0.503348 5.09317 0.765514 4.71017 1.10268 4.373L4.37768 1.098C4.75218 0.733833 5.1596 0.459833 5.59993 0.275999C6.04026 0.0919994 6.50276 0 6.98743 0C7.47193 0 7.93276 0.0919994 8.36993 0.275999C8.80726 0.459833 9.20793 0.733833 9.57193 1.098L10.1452 1.671L10.7182 1.098C11.0925 0.733833 11.4983 0.459833 11.9354 0.275999C12.3726 0.0919994 12.8335 0 13.3182 0C13.8028 0 14.2653 0.0919994 14.7057 0.275999C15.146 0.459833 15.5483 0.733833 15.9124 1.098L19.8874 5.073C20.2514 5.43717 20.5303 5.85158 20.7239 6.31625C20.9174 6.78092 21.0142 7.25558 21.0142 7.74025C21.0142 8.22492 20.9174 8.68583 20.7239 9.123C20.5303 9.56017 20.2514 9.96075 19.8874 10.3247L11.8892 18.3075C11.6687 18.528 11.4203 18.6953 11.1442 18.8095C10.8678 18.9235 10.579 18.9805 10.2777 18.9805Z" fill="white"/></svg>',
          earth: '<svg width="19" height="19" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 19C8.1975 19 6.96833 18.7503 5.8125 18.251C4.65667 17.7517 3.64867 17.0718 2.7885 16.2115C1.92817 15.3513 1.24833 14.3433 0.749 13.1875C0.249667 12.0317 0 10.8025 0 9.5C0 8.18717 0.249667 6.95542 0.749 5.80475C1.24833 4.65408 1.92817 3.64867 2.7885 2.7885C3.64867 1.92817 4.65667 1.24833 5.8125 0.749001C6.96833 0.249667 8.1975 0 9.5 0C10.8128 0 12.0446 0.249667 13.1953 0.749001C14.3459 1.24833 15.3513 1.92817 16.2115 2.7885C17.0718 3.64867 17.7517 4.65408 18.251 5.80475C18.7503 6.95542 19 8.18717 19 9.5C19 10.8025 18.7503 12.0317 18.251 13.1875C17.7517 14.3433 17.0718 15.3513 16.2115 16.2115C15.3513 17.0718 14.3459 17.7517 13.1953 18.251C12.0446 18.7503 10.8128 19 9.5 19ZM9.5 17.4788C10.0103 16.8019 10.4398 16.1192 10.7885 15.4307C11.1372 14.7422 11.4212 13.9897 11.6405 13.173H7.3595C7.59167 14.0153 7.87892 14.7808 8.22125 15.4693C8.56342 16.1578 8.98967 16.8276 9.5 17.4788ZM7.5635 17.2038C7.18017 16.6538 6.83592 16.0285 6.53075 15.328C6.22558 14.6273 5.98842 13.909 5.81925 13.173H2.427C2.95517 14.2115 3.6635 15.084 4.552 15.7905C5.4405 16.4968 6.44433 16.9679 7.5635 17.2038ZM11.4365 17.2038C12.5557 16.9679 13.5595 16.4968 14.448 15.7905C15.3365 15.084 16.0448 14.2115 16.573 13.173H13.1807C12.9794 13.9153 12.7262 14.6368 12.421 15.3375C12.116 16.0382 11.7878 16.6603 11.4365 17.2038ZM1.798 11.673H5.5155C5.45267 11.3013 5.40708 10.9369 5.37875 10.5798C5.35058 10.2228 5.3365 9.86283 5.3365 9.5C5.3365 9.13717 5.35058 8.77725 5.37875 8.42025C5.40708 8.06308 5.45267 7.69867 5.5155 7.327H1.798C1.70183 7.66667 1.62817 8.01983 1.577 8.3865C1.52567 8.75317 1.5 9.12433 1.5 9.5C1.5 9.87567 1.52567 10.2468 1.577 10.6135C1.62817 10.9802 1.70183 11.3333 1.798 11.673ZM7.01525 11.673H11.9848C12.0474 11.3013 12.0929 10.9402 12.1212 10.5895C12.1494 10.2388 12.1635 9.87567 12.1635 9.5C12.1635 9.12433 12.1494 8.76117 12.1212 8.4105C12.0929 8.05983 12.0474 7.69867 11.9848 7.327H7.01525C6.95258 7.69867 6.90708 8.05983 6.87875 8.4105C6.85058 8.76117 6.8365 9.12433 6.8365 9.5C6.8365 9.87567 6.85058 10.2388 6.87875 10.5895C6.90708 10.9402 6.95258 11.3013 7.01525 11.673ZM13.4845 11.673H17.202C17.2982 11.3333 17.3718 10.9802 17.423 10.6135C17.4743 10.2468 17.5 9.87567 17.5 9.5C17.5 9.12433 17.4743 8.75317 17.423 8.3865C17.3718 8.01983 17.2982 7.66667 17.202 7.327H13.4845C13.5473 7.69867 13.5929 8.06308 13.6212 8.42025C13.6494 8.77725 13.6635 9.13717 13.6635 9.5C13.6635 9.86283 13.6494 10.2228 13.6212 10.5798C13.5929 10.9369 13.5473 11.3013 13.4845 11.673ZM13.1807 5.827H16.573C16.0385 4.77567 15.335 3.90317 14.4625 3.2095C13.59 2.516 12.5813 2.04167 11.4365 1.7865C11.8198 2.3685 12.1608 3.00508 12.4595 3.69625C12.7583 4.38725 12.9987 5.0975 13.1807 5.827ZM7.3595 5.827H11.6405C11.4083 4.991 11.1163 4.22075 10.7645 3.51625C10.4125 2.81175 9.991 2.14675 9.5 1.52125C9.009 2.14675 8.5875 2.81175 8.2355 3.51625C7.88367 4.22075 7.59167 4.991 7.3595 5.827ZM2.427 5.827H5.81925C6.00125 5.0975 6.24167 4.38725 6.5405 3.69625C6.83917 3.00508 7.18017 2.3685 7.5635 1.7865C6.41217 2.04167 5.40192 2.51767 4.53275 3.2145C3.66342 3.91117 2.9615 4.782 2.427 5.827Z" fill="white"/></svg>',
          timewatch: '<svg width="17" height="21" viewBox="0 0 17 21" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1.54625 11H4.5C4.6385 11 4.76858 11.0346 4.89025 11.1038C5.01208 11.1731 5.10508 11.277 5.16925 11.4155L6.5 14.0577L9.83075 7.4155C9.96925 7.12833 10.1939 6.98475 10.5048 6.98475C10.8158 6.98475 11.0404 7.12833 11.1788 7.4155L12.9712 11H15.4538C15.2679 9.23583 14.5138 7.75317 13.1913 6.552C11.8689 5.35067 10.3052 4.75 8.5 4.75C6.69483 4.75 5.13108 5.35067 3.80875 6.552C2.48625 7.75317 1.73208 9.23583 1.54625 11ZM8.5 18.75C10.3052 18.75 11.8689 18.1493 13.1913 16.948C14.5138 15.7468 15.2679 14.2642 15.4538 12.5H12.5C12.3615 12.5 12.2314 12.4654 12.1098 12.3963C11.9879 12.3269 11.8949 12.223 11.8307 12.0845L10.5 9.44225L7.16925 16.0943C7.03075 16.3814 6.80608 16.5234 6.49525 16.5203C6.18425 16.5169 5.95958 16.3717 5.82125 16.0845L4.02875 12.5H1.54625C1.73208 14.2642 2.48625 15.7468 3.80875 16.948C5.13108 18.1493 6.69483 18.75 8.5 18.75ZM8.5 20.25C7.33083 20.25 6.23083 20.0269 5.2 19.5807C4.16917 19.1346 3.26792 18.5256 2.49625 17.7538C1.72442 16.9821 1.11542 16.0808 0.66925 15.05C0.223083 14.0192 0 12.9192 0 11.75H1.5C1.5 13.6833 2.18333 15.3333 3.55 16.7C4.91667 18.0667 6.56667 18.75 8.5 18.75C10.4333 18.75 12.0833 18.0667 13.45 16.7C14.8167 15.3333 15.5 13.6833 15.5 11.75H17C17 12.9192 16.7769 14.0192 16.3307 15.05C15.8846 16.0808 15.2756 16.9821 14.5038 17.7538C13.7321 18.5256 12.8308 19.1346 11.8 19.5807C10.7692 20.0269 9.66917 20.25 8.5 20.25ZM0 11.75C0 10.5808 0.223083 9.48083 0.66925 8.45C1.11542 7.41917 1.72442 6.51792 2.49625 5.74625C3.26792 4.97442 4.16917 4.36542 5.2 3.91925C6.23083 3.47308 7.33083 3.25 8.5 3.25C9.50133 3.25 10.4657 3.41992 11.3932 3.75975C12.3207 4.09942 13.182 4.58592 13.977 5.21925L15.223 3.97325L16.2768 5.027L15.0307 6.273C15.6641 7.068 16.1506 7.92925 16.4902 8.85675C16.8301 9.78425 17 10.7487 17 11.75H15.5C15.5 9.81667 14.8167 8.16667 13.45 6.8C12.0833 5.43333 10.4333 4.75 8.5 4.75C6.56667 4.75 4.91667 5.43333 3.55 6.8C2.18333 8.16667 1.5 9.81667 1.5 11.75H0ZM5.69225 1.5V0H11.3077V1.5H5.69225ZM8.5 18.75C6.56667 18.75 4.91667 18.0667 3.55 16.7C2.18333 15.3333 1.5 13.6833 1.5 11.75C1.5 9.81667 2.18333 8.16667 3.55 6.8C4.91667 5.43333 6.56667 4.75 8.5 4.75C10.4333 4.75 12.0833 5.43333 13.45 6.8C14.8167 8.16667 15.5 9.81667 15.5 11.75C15.5 13.6833 14.8167 15.3333 13.45 16.7C12.0833 18.0667 10.4333 18.75 8.5 18.75Z" fill="white"/></svg>',
          global_book: '<svg width="19" height="17" viewBox="0 0 19 17" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1.04625 9.43275C1.02958 9.27892 1.01708 9.12342 1.00875 8.96625C1.00042 8.80925 0.99625 8.65383 0.99625 8.5C0.99625 7.3205 1.21833 6.21542 1.6625 5.18475C2.10683 4.15392 2.71483 3.25517 3.4865 2.4885C4.25833 1.72183 5.15867 1.11542 6.1875 0.66925C7.21633 0.223084 8.3205 0 9.5 0C10.6858 0 11.7958 0.223084 12.8298 0.66925C13.8638 1.11542 14.7641 1.72183 15.5307 2.4885C16.2974 3.25517 16.9054 4.15392 17.3547 5.18475C17.8041 6.21542 18.0288 7.3205 18.0288 8.5C18.0288 8.65383 18.0246 8.80925 18.0163 8.96625C18.0079 9.12342 17.9954 9.27892 17.9788 9.43275H16.4635C16.4903 9.27892 16.5079 9.12342 16.5163 8.96625C16.5246 8.80925 16.5288 8.65383 16.5288 8.5C16.5288 8.30133 16.5214 8.10258 16.5068 7.90375C16.4919 7.70508 16.4647 7.50958 16.425 7.31725H13.1193C13.1423 7.50958 13.1554 7.70508 13.1587 7.90375C13.1619 8.10258 13.1635 8.30133 13.1635 8.5V8.96625C13.1635 9.12342 13.1552 9.27892 13.1385 9.43275H11.6635V8.675C11.6635 8.4365 11.6593 8.20442 11.651 7.97875C11.6427 7.75308 11.6269 7.53258 11.6038 7.31725H7.4115C7.3885 7.53258 7.37283 7.75308 7.3645 7.97875C7.35617 8.20442 7.352 8.4365 7.352 8.675V9.43275H5.877C5.86033 9.27892 5.852 9.12342 5.852 8.96625V8.5C5.852 8.30133 5.85358 8.10258 5.85675 7.90375C5.85992 7.70508 5.87308 7.50958 5.89625 7.31725H2.6C2.56033 7.50958 2.53308 7.70508 2.51825 7.90375C2.50358 8.10258 2.49625 8.30133 2.49625 8.5C2.49625 8.65383 2.50042 8.80925 2.50875 8.96625C2.51708 9.12342 2.53467 9.27892 2.5615 9.43275H1.04625ZM3.04625 5.81725H6.0635C6.216 4.92108 6.42592 4.14708 6.69325 3.49525C6.96058 2.84325 7.27825 2.28392 7.64625 1.81725C6.61542 2.05325 5.69167 2.52508 4.875 3.23275C4.05833 3.94042 3.44875 4.80192 3.04625 5.81725ZM7.61925 5.81725H11.3807C11.2269 5.04292 11.0026 4.29325 10.7078 3.56825C10.4129 2.84325 10.0103 2.18592 9.5 1.59625C8.98967 2.19242 8.58617 2.85133 8.2895 3.573C7.99267 4.29483 7.76925 5.04292 7.61925 5.81725ZM12.952 5.81725H15.9788C15.5763 4.79542 14.9577 3.93225 14.123 3.22775C13.2883 2.52342 12.3524 2.05325 11.3152 1.81725C11.6961 2.31092 12.0259 2.88333 12.3048 3.5345C12.5836 4.18583 12.7993 4.94675 12.952 5.81725ZM8.75 17V16.25C8.75 15.3782 8.44392 14.6394 7.83175 14.0337C7.21958 13.4279 6.47758 13.125 5.60575 13.125H0V11.625H5.60575C6.41225 11.625 7.1565 11.8144 7.8385 12.1933C8.5205 12.5721 9.07433 13.0943 9.5 13.7598C9.92567 13.0943 10.4795 12.5721 11.1615 12.1933C11.8435 11.8144 12.5845 11.625 13.3845 11.625H19V13.125H13.3845C12.5128 13.125 11.7725 13.4279 11.1635 14.0337C10.5545 14.6394 10.25 15.3782 10.25 16.25V17H8.75Z" fill="white"/></svg>',
          finance: '<svg width="19" height="19" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4.75 10.6115V4H7.0575V10.6115L5.90375 9.49975L4.75 10.6115ZM9.423 12.4768V0H11.7305V10.1693L9.423 12.4768ZM0.0577499 15.273V8H2.36525V12.9653L0.0577499 15.273ZM0 18.4538L5.873 12.5808L9.423 15.6308L15.6 9.45375H13.6538V7.95375H18.1538V12.4538H16.6538V10.5075L9.4845 17.6768L5.9345 14.6268L2.1075 18.4538H0Z" fill="white"/></svg>',
          query_stats: '<svg width="19" height="20" viewBox="0 0 19 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1.22125 12.1403L0 11.2635L4.625 3.85L7.56725 7.29225L11.4712 0.936501L14.4135 5.35975L17.7788 0L18.9807 0.886501L14.4443 8.1115L11.527 3.7135L7.775 9.821L4.81725 6.3635L1.22125 12.1403ZM12.8077 16.5C13.5589 16.5 14.1938 16.2407 14.7125 15.722C15.2312 15.2033 15.4905 14.5684 15.4905 13.8173C15.4905 13.0659 15.2311 12.431 14.7122 11.9125C14.1936 11.3938 13.5587 11.1345 12.8075 11.1345C12.0563 11.1345 11.4214 11.3938 10.9028 11.9125C10.3842 12.4313 10.125 13.0663 10.125 13.8175C10.125 14.5687 10.3843 15.2035 10.903 15.722C11.4217 16.2407 12.0566 16.5 12.8077 16.5ZM17.9365 20L15.1788 17.2423C14.8416 17.4884 14.4721 17.6763 14.0703 17.8057C13.6683 17.9352 13.2474 18 12.8077 18C11.6459 18 10.6583 17.5935 9.845 16.7805C9.03167 15.9675 8.625 14.9803 8.625 13.819C8.625 12.6577 9.0315 11.6699 9.8445 10.8558C10.6575 10.0417 11.6447 9.63475 12.806 9.63475C13.9673 9.63475 14.9551 10.0413 15.7693 10.8545C16.5833 11.6678 16.9902 12.6554 16.9902 13.8173C16.9902 14.2571 16.9255 14.6795 16.796 15.0845C16.6667 15.4897 16.4789 15.8608 16.2327 16.198L18.9807 18.9557L17.9365 20Z" fill="white"/></svg>',
          bar_chart: '<svg width="19" height="17" viewBox="0 0 19 17" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M0 17V15.5H19V17H0ZM1 14.1152V8H3.5V14.1152H1ZM5.827 14.1152V3H8.327V14.1152H5.827ZM10.6635 14.1152V6H13.1635V14.1152H10.6635ZM15.5 14.1152V0H18V14.1152H15.5Z" fill="#0273CF"/></svg>',
        };

        if (iconMap[iconName]) {
          iconDiv.innerHTML = iconMap[iconName];
          // Ensure icon is marked as decorative
          iconDiv.setAttribute('aria-hidden', 'true');
          const svg = iconDiv.querySelector('svg');
          if (svg) {
            svg.setAttribute('aria-hidden', 'true');
            svg.setAttribute('focusable', 'false');
          }
          // Remove the icon name paragraph from body
          firstP.remove();
        }
      }
    }

    // Handle Icon Background Color
    if (iconDiv && cardBody) {
      const firstP = cardBody.querySelector('p:first-of-type');
      if (firstP) {
        const color = firstP.textContent.trim().toLowerCase();
        const validColors = ['cppi-blue', 'light-grey'];

        if (validColors.includes(color)) {
          iconDiv.classList.add(color);
          // Remove the color paragraph from body
          firstP.remove();
        }
      }
    }

    // Handle link based on last two p tags
    if (cardBody) {
      // Find all paragraphs in the card body
      const allParagraphs = Array.from(cardBody.querySelectorAll('p'));

      // Find the last two paragraphs that are link-related
      let lastP = null;
      let secondLastP = null;

      // Walk backwards through all paragraphs to find the last two that are link-related
      for (let i = allParagraphs.length - 1; i >= 0; i -= 1) {
        const p = allParagraphs[i];
        const anchor = p.querySelector('a[href]');

        if (anchor && !lastP) {
          lastP = p;
        } else if (lastP && !secondLastP && i < allParagraphs.length - 1) {
          secondLastP = p;
          break;
        }
      }

      // If we found both paragraphs
      if (lastP && secondLastP && lastP.querySelector('a[href]')) {
        const anchor = lastP.querySelector('a[href]');
        const linkHref = anchor.getAttribute('href');
        const linkTitle = anchor.getAttribute('title') || linkHref;
        const linkLabelText = secondLastP.textContent.trim();

        if (linkLabelText && linkHref) {
          // Get card title for better aria-label context
          const cardTitle = cardBody.querySelector('h1, h2, h3, h4, h5, h6');
          const cardTitleText = cardTitle ? cardTitle.textContent.trim() : '';
          const ariaLabel = cardTitleText
            ? `${linkLabelText}, ${cardTitleText}`
            : linkLabelText;

          // Create combined link HTML using template literal
          const linkHtml = `
            <p>
              <a href="${linkHref}"
                 title="${linkTitle}"
                 class="cards-link link-primary"
                 aria-label="${ariaLabel}">
                ${linkLabelText}
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
                  <path d="M12.175 9H0V7H12.175L6.575 1.4L8 0L16 8L8 16L6.575 14.6L12.175 9Z" fill="#0273CF"/>
                </svg>
              </a>
            </p>
          `;

          // Replace the second-to-last paragraph with combined link
          secondLastP.outerHTML = linkHtml;

          // Remove the last paragraph (the one with anchor tag)
          lastP.remove();
        }
      }
    }

    // Ensure correct order: cards-card-image first, then card-icon, then cards-card-body
    const imageDiv = li.querySelector('.cards-card-image');
    if (!iconDiv) {
      iconDiv = li.querySelector('.card-icon');
    }
    const bodyDiv = li.querySelector('.cards-card-body');

    // Add accessibility attributes to image div
    if (imageDiv) {
      const img = imageDiv.querySelector('img');
      if (img && !img.getAttribute('alt') && !img.getAttribute('aria-hidden')) {
        // If no alt text, mark as decorative
        img.setAttribute('alt', '');
        img.setAttribute('aria-hidden', 'true');
      }
    }

    // Ensure icon div has aria-hidden if it exists
    if (iconDiv && !iconDiv.getAttribute('aria-hidden')) {
      iconDiv.setAttribute('aria-hidden', 'true');
    }

    // Add proper structure to card body
    if (bodyDiv) {
      // Ensure heading hierarchy is maintained
      const headings = bodyDiv.querySelectorAll('h1, h2, h3, h4, h5, h6');
      if (headings.length > 0) {
        const firstHeading = headings[0];
        // Set aria-labelledby to link card to its heading
        const headingId = firstHeading.id || `card-heading-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
        if (!firstHeading.id) {
          firstHeading.id = headingId;
        }
        li.setAttribute('aria-labelledby', headingId);
        // Update aria-label to be more descriptive with heading text
        const headingText = firstHeading.textContent.trim();
        li.setAttribute('aria-label', headingText);

        // Find description paragraph and link it with aria-describedby
        const paragraphs = bodyDiv.querySelectorAll('p');
        const descriptionParagraphs = Array.from(paragraphs).filter((p) => {
          const link = p.querySelector('a');
          return !link && p.textContent.trim() && p.textContent.trim().length > 20;
        });

        if (descriptionParagraphs.length > 0) {
          const firstDesc = descriptionParagraphs[0];
          const descId = firstDesc.id || `card-desc-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
          if (!firstDesc.id) {
            firstDesc.id = descId;
          }
          li.setAttribute('aria-describedby', descId);
        }
      } else {
        // If no heading, try to use first paragraph as label
        const firstParagraph = bodyDiv.querySelector('p');
        if (firstParagraph && firstParagraph.textContent.trim()) {
          const paraText = firstParagraph.textContent.trim().substring(0, 50);
          li.setAttribute('aria-label', paraText);
        }
      }
    }

    // Collect elements in correct order
    const orderedElements = [];
    if (imageDiv) orderedElements.push(imageDiv);
    if (iconDiv) orderedElements.push(iconDiv);
    if (bodyDiv) orderedElements.push(bodyDiv);

    // Reorder if needed
    if (orderedElements.length > 1) {
      orderedElements.forEach((el) => {
        li.appendChild(el);
      });
    }
  });

  block.textContent = '';
  block.append(ul);
}
